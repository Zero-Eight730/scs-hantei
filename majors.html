<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>志望学類登録 - 成績計算サイト</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
</head>
<body>
    <div id="main-app" class="container" style="display:none;">
        <nav>
　　　　　    <a href="input.html">成績入力</a>
    　　　　　<a href="view.html">成績参照</a>
　　　　　    <a href="judge.html">判定実行</a>
    　　　　　<strong>志望学類登録</strong>
    　　　　　<a href="rules.html" class="admin-only">ルール設定</a>
   　　　　　 <a href="admin-settings.html" class="admin-only">ランキング設定</a>
    　　　　　<a href="account.html">アカウント管理</a>
        </nav>
        <div class="user-status">
            <span id="user-display"></span>
            <button id="logout-btn" class="btn-danger" style="padding: 5px 10px; font-size: 14px;">ログアウト</button>
        </div>
        <div class="panel">
            <h2>志望学類登録</h2>
            <p style="text-align:center;">「ルール設定」で作成された学類の中から、判定ページに表示したいものを選択してください。</p>
            <div id="majors-checkbox-container" class="major-selection-grid">
                <p style="text-align:center; color: #666;">ルールを読み込み中...</p>
            </div>
            <button id="save-btn" class="btn-main" style="width: 100%; margin-top: 20px;">選択を保存</button>
        </div>
    </div>
    <script>
        let currentUser = null;
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const majorsCheckboxContainer = document.getElementById('majors-checkbox-container');
        const saveBtn = document.getElementById('save-btn');

        async function setupUserInterface() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) {
                if (window.location.pathname !== '/index.html' && window.location.pathname !== '/register.html') {
                    window.location.href = 'index.html';
                }
                return null;
            }
            const user = session.user;
            const mainApp = document.getElementById('main-app');
            if (mainApp) mainApp.style.display = 'block';
            if (userDisplay) userDisplay.textContent = `${user.email} でログイン中`;
            const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', user.id).single();
            const isAdmin = profile && profile.role === 'admin';
            document.querySelectorAll('.admin-only').forEach(link => {
                if (isAdmin) {
                    link.style.display = 'inline-block';
                }
            });
            return { user, isAdmin };
        }

        async function initializeApp() {
            try {
                const { data: profileData, error: profileError } = await supabaseClient.from('profiles').select('role').eq('id', currentUser.id).single();
                if (profileError) throw profileError;
                const userRole = profileData ? profileData.role : 'user';

                const { data: rules, error: rulesError } = await supabaseClient.from('major_rules').select('name, allowed_roles');
                if (rulesError) throw rulesError;
                
                const { data: userData, error: userError } = await supabaseClient.from('user_data').select('target_majors').eq('id', currentUser.id).single();
                if (userError && userError.code !== 'PGRST116') throw userError;
                
                const targetMajors = userData?.target_majors || [];
                
                const availableRules = rules.filter(rule => rule.allowed_roles && rule.allowed_roles.includes(userRole));

                majorsCheckboxContainer.innerHTML = '';
                if (availableRules.length === 0) {
                    majorsCheckboxContainer.innerHTML = '<p style="text-align:center; color: #666;">あなたのロールで選択可能な学類ルールがありません。管理者がルールを作成するまでお待ちください。</p>';
                    saveBtn.disabled = true;
                    return;
                }

                availableRules.forEach(rule => {
                    const id = `major-${rule.name.replace(/\s/g, '-')}`;
                    const isChecked = targetMajors.includes(rule.name);
                    const div = document.createElement('div');
                    div.innerHTML = `<input type="checkbox" class="major-checkbox" id="${id}" value="${rule.name}" ${isChecked ? 'checked' : ''}><label for="${id}">${rule.name}</label>`;
                    majorsCheckboxContainer.appendChild(div);
                });

            } catch (e) {
                majorsCheckboxContainer.innerHTML = `<p style="text-align:center; color: var(--danger-color);">データの読み込みに失敗しました。</p>`;
                console.error('カスタムルール等の読み込み失敗:', e);
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const sessionInfo = await setupUserInterface();
            if(sessionInfo) {
                currentUser = sessionInfo.user;
                await initializeApp();
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        });

        saveBtn.addEventListener('click', async () => {
            const selectedMajors = Array.from(document.querySelectorAll('.major-checkbox:checked'))
                .map(checkbox => checkbox.value);
            
            const { data: existingData } = await supabaseClient.from('user_data').select('subjects, custom_rules').eq('id', currentUser.id).single();

            const updatedData = { 
                id: currentUser.id, 
                subjects: existingData ? existingData.subjects : [],
                custom_rules: existingData ? existingData.custom_rules : [],
                target_majors: selectedMajors, 
                updated_at: new Date()
            };

            const { error } = await supabaseClient.from('user_data').upsert(updatedData);

            if (error) {
                alert('保存に失敗しました: ' + error.message);
            } else {
                alert('志望学類を保存しました。');
            }
        });
    </script>
</body>
</html>
