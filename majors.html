<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>志望学類登録 - 成績計算サイト</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
</head>
<body>
    <div id="main-app" class="container" style="display:none;">
        <nav>
            <a href="input.html">成績入力</a>
            <a href="view.html">成績参照</a>
            <strong>志望学類登録</strong>
            <a href="judge.html">判定実行</a>
            <a href="account.html">アカウント管理</a>
        </nav>
        <div class="user-status">
            <span id="user-display"></span>
            <button id="logout-btn" class="btn-danger" style="padding: 5px 10px; font-size: 14px;">ログアウト</button>
        </div>
        <div class="panel">
            <h2>志望学類登録</h2>
            <p style="text-align:center;">判定ページに表示したい学類をすべて選択し、保存してください。</p>
            <div id="majors-checkbox-container" class="major-selection-grid">
                </div>
            <button id="save-btn" class="btn-main" style="width: 100%; margin-top: 20px;">選択を保存</button>
        </div>
    </div>
    <script>
        let currentUser = null;
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const majorsCheckboxContainer = document.getElementById('majors-checkbox-container');
        const saveBtn = document.getElementById('save-btn');
        const allMajors = ['情報科学類（区分A）', '情報科学類（区分B）', '情報メディア創成学類', '知識情報・図書館学類', '物理学類'];

        async function checkSessionAndInitialize() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) {
                window.location.href = 'index.html';
                return;
            }
            currentUser = session.user;
            document.getElementById('main-app').style.display = 'block';
            userDisplay.textContent = `${currentUser.email} でログイン中`;
            await initializeApp();
        }

        async function initializeApp() {
            // チェックボックスを描画
            allMajors.forEach(major => {
                const id = `major-${major}`;
                const div = document.createElement('div');
                div.innerHTML = `<input type="checkbox" class="major-checkbox" id="${id}" value="${major}"><label for="${id}">${major}</label>`;
                majorsCheckboxContainer.appendChild(div.firstElementChild);
                majorsCheckboxContainer.appendChild(div.lastElementChild);
            });
            // 保存済みの選択を読み込む
            await loadTargetMajors();
        }

        async function loadTargetMajors() {
            try {
                const { data, error } = await supabaseClient
                    .from('user_data')
                    .select('target_majors')
                    .eq('id', currentUser.id)
                    .single();
                if (error && error.code !== 'PGRST116') throw error;
                
                if (data && data.target_majors) {
                    data.target_majors.forEach(majorName => {
                        const checkbox = document.querySelector(`.major-checkbox[value="${majorName}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    });
                }
            } catch (e) {
                console.error('志望学類の読み込みに失敗:', e);
            }
        }

        document.addEventListener('DOMContentLoaded', checkSessionAndInitialize);
        logoutBtn.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        });

        saveBtn.addEventListener('click', async () => {
            const selectedMajors = Array.from(document.querySelectorAll('.major-checkbox:checked'))
                .map(checkbox => checkbox.value);

            const { data, error } = await supabaseClient
                .from('user_data')
                .upsert({ id: currentUser.id, target_majors: selectedMajors, updated_at: new Date() });

            if (error) {
                alert('保存に失敗しました: ' + error.message);
            } else {
                alert('志望学類を保存しました。');
            }
        });
    </script>
</body>
</html>
