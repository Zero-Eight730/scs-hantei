<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>判定 - モギモギ判定</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="common.js"></script>
</head>
<body>
    <div id="main-app" class="container" style="display:none;">
        <nav>
            <a href="input.html">成績入力</a>
            <a href="view.html">成績参照</a>
            <strong>判定</strong>
            <a href="majors.html">志望学類登録</a>
            <a href="rules.html" class="admin-only">学類登録</a>
            <a href="admin-settings.html" class="admin-only">公開設定</a>
            <a href="account.html">アカウント</a>
        </nav>
        <div class="user-status">
             <span id="user-display"></span>
             <button id="logout-btn" class="btn-danger" style="padding: 5px 10px; font-size: 14px;">ログアウト</button>
        </div>
        <div class="panel">
            <h2>判定</h2>
            <p style="text-align:center;">「志望学類登録」で選択した学類の移行点を計算します。</p>
            <button id="calculate-btn" class="btn-main" style="width:100%; padding: 15px; font-size: 18px;">表示</button>
            <div id="results-container"></div>
        </div>
    </div>
    <script>
        let currentUser = null;
        let userRole = 'user';
        let savedSubjects = [];
        let allPublicRules = [];
        let targetMajors = [];
        let rankingSettings = {}; 
        
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const calculateBtn = document.getElementById('calculate-btn');
        const resultsContainer = document.getElementById('results-container');
        
        async function setupUserInterface() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) {
                if (window.location.pathname.endsWith('/') || window.location.pathname.endsWith('/login.html') || window.location.pathname.endsWith('/register.html')) {
                    // Do nothing on login/register pages
                } else {
                    window.location.href = 'login.html';
                }
                return null;
            }
            const user = session.user;
            const mainApp = document.getElementById('main-app');
            if (mainApp) mainApp.style.display = 'block';
            if (userDisplay) userDisplay.textContent = `${user.email} でログイン中`;
            const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', user.id).single();
            const isAdmin = profile && profile.role === 'admin';
            document.querySelectorAll('.admin-only').forEach(link => {
                if (isAdmin) { link.style.display = 'inline-block'; }
            });
            return { user, isAdmin, role: profile.role };
        }
        
        async function loadInitialData() {
            try {
                const { data: userData, error: userError } = await supabaseClient.from('user_data').select('subjects, target_majors').eq('id', currentUser.id).single();
                if (userError && userError.code !== 'PGRST116') throw userError;
                savedSubjects = (userData?.subjects || []).map(s => ({ name: s.name, credits: parseFloat(s.credits), grade: parseFloat(s.grade) })).filter(s => s.name && !isNaN(s.credits) && !isNaN(s.grade));
                targetMajors = userData?.target_majors || [];

                const { data: rulesData, error: rulesError } = await supabaseClient.from('major_rules').select('name, allowed_roles, rule_data').order('sort_order');
                if (rulesError) throw rulesError;
                allPublicRules = rulesData.map(r => ({ ...r.rule_data, name: r.name, allowed_roles: r.allowed_roles }));

                const { data: settingsData, error: settingsError } = await supabaseClient.from('app_settings').select('settings').eq('id', 1).single();
                if (settingsError) throw settingsError;
                rankingSettings = settingsData.settings;

            } catch (e) {
                resultsContainer.innerHTML = `<p style="text-align:center; color: var(--danger-color);">${e.message || 'データの読み込みに失敗しました。'}</p>`;
                calculateBtn.disabled = true;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const sessionInfo = await setupUserInterface();
            if (sessionInfo) {
                currentUser = sessionInfo.user;
                userRole = sessionInfo.role;
                await loadInitialData();
            }
        });
        
        logoutBtn.addEventListener('click', async () => { await supabaseClient.auth.signOut(); window.location.href = 'login.html'; });

        calculateBtn.addEventListener('click', async () => {
            if (savedSubjects.length === 0) { alert('計算対象の科目がありません。「成績入力」ページでデータを保存してください。'); return; }
            if (targetMajors.length === 0) { alert('計算対象の学類がありません。「志望学類登録」ページで設定してください。'); return; }
            
            calculateBtn.disabled = true;
            calculateBtn.textContent = '計算・スコア更新中...';
            resultsContainer.innerHTML = '';
            
            try {
                const scoresToUpsert = [];
                allPublicRules.forEach(rule => {
                    const result = rule.type === 'tiered' ? calculateTieredMajor(savedSubjects, rule) : calculateStandardMajor(savedSubjects, rule);
                    scoresToUpsert.push({ id: currentUser.id, major: rule.name, score: result.score });
                });

                if (scoresToUpsert.length > 0) {
                    const { error: scoreSaveError } = await supabaseClient.from('user_scores').upsert(scoresToUpsert, { onConflict: 'id, major' });
                    if (scoreSaveError) throw scoreSaveError;
                }

                const rulesToCalculate = allPublicRules.filter(rule => targetMajors.includes(rule.name));
                if (rulesToCalculate.length === 0) {
                    resultsContainer.innerHTML = `<p style="text-align:center;">選択された志望学類が見つかりません。</p>`;
                } else {
                    rulesToCalculate.forEach(rule => {
                        const result = rule.type === 'tiered' ? calculateTieredMajor(savedSubjects, rule) : calculateStandardMajor(savedSubjects, rule);
                        renderResultCard(rule.name, result, rule);
                    });
                }
            } catch(error) {
                 resultsContainer.innerHTML = `<p style="text-align:center; color: var(--danger-color);">${error.message}</p>`;
            } finally {
                calculateBtn.disabled = false;
                calculateBtn.textContent = '表示';
            }
        });
        
        async function renderResultCard(majorName, result, rule) {
            const card = document.createElement('div');
            card.className = `result-card`;
            const safeMajorName = (majorName || 'unknown').replace(/[\s()（）]/g, '');
            const percentage = result.maxScore > 0 ? (result.score / result.maxScore) * 100 : 0;
            let breakdownHTML = result.breakdown.length > 0 ? '<ul>' + result.breakdown.map(item => { const className = item.status === 'included' ? 'status-included' : 'status-excluded'; const text = item.status === 'included' ? item.text : `${item.text} - ${item.reason}`; return `<li class="${className}">${text}</li>`; }).join('') + '</ul>' : '<p>計算対象なし</p>';

            const now = new Date();
            const startTime = rankingSettings.ranking_start_time ? new Date(rankingSettings.ranking_start_time) : null;
            const endTime = rankingSettings.ranking_end_time ? new Date(rankingSettings.ranking_end_time) : null;
            const isEvaluationPublic = rankingSettings.ranking_enabled && (!startTime || now >= startTime) && (!endTime || now <= endTime);

            let judgmentHTML = '';
            let detailsHTML = '';

            // 常に表示する項目
            const coreDetails = `
                <div class="detail-item"><span class="label">移行点</span><span class="value">${result.score.toFixed(2)}</span></div>
                <div class="detail-item"><span class="label">得点率</span><span class="value">${percentage.toFixed(2)} %</span></div>
            `;

            if (isEvaluationPublic) {
                const isApplicable = (rule.allowed_roles || []).includes(userRole);
                const thresholds = isApplicable ? rule.thresholds?.applicable : rule.thresholds?.non_applicable;
                let judgment = 'N/A', judgmentClass = 'judgment-E';
                if (thresholds && thresholds.pass !== undefined && thresholds.median !== undefined) {
                    const p_plus_thresh_percent = rule.maxPossibleScore > 0 ? (thresholds.median / rule.maxPossibleScore) * 100 : 0;
                    const p_thresh_percent = rule.maxPossibleScore > 0 ? (thresholds.pass / rule.maxPossibleScore) * 100 : 0;
                    const b_thresh_percent = (p_plus_thresh_percent + p_thresh_percent) / 2;
                    const d_thresh_percent = p_thresh_percent - (b_thresh_percent - p_thresh_percent);
                    if (percentage >= p_plus_thresh_percent) { judgment = 'A'; judgmentClass = 'judgment-A'; } 
                    else if (percentage >= b_thresh_percent) { judgment = 'B'; judgmentClass = 'judgment-B'; } 
                    else if (percentage >= p_thresh_percent) { judgment = 'C'; judgmentClass = 'judgment-C'; } 
                    else if (percentage >= d_thresh_percent) { judgment = 'D'; judgmentClass = 'judgment-D'; } 
                    else { judgment = 'E'; judgmentClass = 'judgment-E'; }
                }
                card.style.borderTopColor = `var(--grade-${judgment}-color)`;
                judgmentHTML = `<div class="judgment-display"><div class="judgment-circle grade-${judgment}"><span>${judgment}</span></div></div>`;
                detailsHTML = `
                    ${coreDetails}
                    <div class="rank-info" id="rank-${safeMajorName}"><p>順位を読み込み中...</p></div>
                `;
            } else {
                card.style.borderTopColor = '#6c757d';
                judgmentHTML = ``;
                detailsHTML = `
                    ${coreDetails}
                    <div class="rank-info"><p style="font-size: 0.9em; color: var(--text-muted);">判定・ランキングは現在非公開です</p></div>
                `;
            }
            
            card.innerHTML = `
                <div class="card-header"><h4>${majorName || '名称未設定'}</h4></div>
                ${judgmentHTML}
                <div class="details-display">${detailsHTML}</div>
                <div class="breakdown-display"><details><summary>内訳</summary>${breakdownHTML}</details></div>
            `;
            resultsContainer.appendChild(card);
            
            if (isEvaluationPublic) {
                try {
                    const { data, error } = await supabaseClient.rpc('get_rank_and_deviation', { major_name: majorName });
                    if (error) throw new Error(error.message);
                    if (!data || data.length === 0) throw new Error('スコア未登録か、比較対象がいません');
                    
                    const rankData = data[0];
                    const rankLabel = rankData.is_applicable ? '順位 (優先区分内)' : '順位 (全区分内)';
                    
                    const rankInfoDiv = document.getElementById(`rank-${safeMajorName}`);
                    if (rankInfoDiv) {
                        rankInfoDiv.innerHTML = `
                            <div class="detail-item"><span class="label">区分</span><span class="value">${rankData.is_applicable ? '優先区分' : '全区分'}</span></div>
                            <div class="detail-item"><span class="label">偏差値</span><span class="value">${rankData.deviation_score.toFixed(2)}</span></div>
                            <div class="detail-item" style="border-bottom: none;"><span class="label">${rankLabel}</span><span class="value">${rankData.rank} / ${rankData.total}人</span></div>
                        `;
                    }
                } catch (error) {
                    const rankInfoDiv = document.getElementById(`rank-${safeMajorName}`);
                    if (rankInfoDiv) {
                        rankInfoDiv.innerHTML = `<p style="font-size: 0.9em; color: var(--text-muted);">${error.message}</p>`;
                    }
                }
            }
        }
    </script>
</body>
</html>
