<!DOCTYPE html>
<html lang="ja">
<head>
    </head>
<body>
    <div id="main-app" class="container" style="display:none;">
        <nav>
            <a href="input.html">成績入力</a>
            <a href="view.html">成績参照</a>
            <strong>判定実行</strong>
            <a href="majors.html">志望学類登録</a>
            <a href="rules.html" class="admin-only">ルール設定</a>
            <a href="admin-settings.html" class="admin-only">ランキング設定</a> <a href="account.html">アカウント管理</a>
        </nav>
        </div>
    <script>
        let currentUser = null;
        let savedSubjects = [];
        let allPublicRules = [];
        let targetMajors = [];
        let rankingSettings = {}; // ★ 追加

        // ... DOM要素取得 ...

        async function setupUserInterface() { /* ... 変更なし ... */ }

        async function loadInitialData() {
            try {
                // ユーザーデータ、ルールデータを読み込む
                const { data: userData, error: userError } = await supabaseClient.from('user_data').select('subjects, target_majors').eq('id', currentUser.id).single();
                if (userError && userError.code !== 'PGRST116') throw userError;
                savedSubjects = (userData?.subjects || []).map(s => ({ name: s.name, credits: parseFloat(s.credits), grade: parseFloat(s.grade) })).filter(s => s.name && !isNaN(s.credits) && !isNaN(s.grade));
                targetMajors = userData?.target_majors || [];

                const { data: rulesData, error: rulesError } = await supabaseClient.from('major_rules').select('name, rule_data');
                if (rulesError) throw rulesError;
                allPublicRules = rulesData.map(r => ({ ...r.rule_data, name: r.name }));

                // ★ ランキング設定を読み込む
                const { data: settingsData, error: settingsError } = await supabaseClient.from('app_settings').select('settings').eq('id', 1).single();
                if (settingsError) throw settingsError;
                rankingSettings = settingsData.settings;

            } catch (e) { /* ... エラー処理 ... */ }
        }

        // ... calculateBtn イベントリスナーは変更なし ...
        
        async function renderResultCard(majorName, result, rule) {
            // ... 判定ロジックは変更なし ...
            
            const card = document.createElement('div');
            // ... カードのHTML生成 ...
            card.innerHTML = `
                <div class="rank-info" id="rank-${safeMajorName}"><p>...</p></div>
                `;
            resultsContainer.appendChild(card);

            // ▼▼▼ ランキング表示の前に権限チェックを追加 ▼▼▼
            const now = new Date();
            const startTime = rankingSettings.ranking_start_time ? new Date(rankingSettings.ranking_start_time) : null;
            const endTime = rankingSettings.ranking_end_time ? new Date(rankingSettings.ranking_end_time) : null;
            
            const isTimeValid = (!startTime || now >= startTime) && (!endTime || now <= endTime);

            if (rankingSettings.ranking_enabled && isTimeValid) {
                // 公開中の場合のみ、順位と偏差値を取得
                try {
                    const { data, error } = await supabaseClient.rpc('get_rank_and_deviation', { major_name: majorName });
                    if (error) throw new Error(error.message);
                    if (!data || data.length === 0) throw new Error('スコア未登録か、比較対象がいません');
                    const rankData = data[0];
                    document.getElementById(`rank-${safeMajorName}`).innerHTML = `
                        <div class="detail-item"><span class="label">偏差値</span><span class="value">${rankData.deviation_score.toFixed(2)}</span></div>
                        <div class="detail-item" style="border-bottom: none;"><span class="label">順位</span><span class="value">${rankData.rank} / ${rankData.total}人</span></div>
                    `;
                } catch (error) {
                    document.getElementById(`rank-${safeMajorName}`).innerHTML = `<p style="font-size: 0.9em; color: var(--text-muted);">${error.message}</p>`;
                }
            } else {
                // 非公開の場合
                document.getElementById(`rank-${safeMajorName}`).innerHTML = `<p style="font-size: 0.9em; color: var(--text-muted);">ランキングは現在非公開です</p>`;
            }
        }
    </script>
</body>
</html>
