<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>判定実行 - 成績計算サイト</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
    <script src="common.js"></script>
</head>
<body>
    <div id="main-app" class="container" style="display:none;">
        <nav>
          <a href="input.html">成績入力</a>
          <a href="view.html">成績参照</a>
          <strong>判定実行</strong>
          <a href="majors.html">志望学類登録</a>
          <a href="rules.html" class="admin-only">ルール設定</a>
          <a href="admin-settings.html" class="admin-only">ランキング設定</a>
          <a href="account.html">アカウント管理</a>
        </nav>
        <div class="user-status">
             <span id="user-display"></span>
             <button id="logout-btn" class="btn-danger" style="padding: 5px 10px; font-size: 14px;">ログアウト</button>
        </div>
        <div class="panel">
            <h2>判定実行</h2>
            <p style="text-align:center;">「志望学類登録」で選択した学類の移行点を計算します。</p>
            <button id="calculate-btn" class="btn-main" style="width:100%; padding: 15px; font-size: 18px;">計算を実行</button>
            <div class="table-wrapper">
                <table id="judgement-table">
                    <thead>
                        <tr>
                            <th class="col-name">志望学類</th>
                            <th class="col-score">移行点</th>
                            <th class="col-percentage">得点率</th>
                            <th class="col-judgment">判定</th>
                            <th class="col-rank">順位</th>
                        </tr>
                    </thead>
                    <tbody id="results-container"></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        let currentUser = null;
        let savedSubjects = [];
        let allPublicRules = [];
        let targetMajors = [];
        let rankingSettings = {}; 
        
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const calculateBtn = document.getElementById('calculate-btn');
        const resultsContainer = document.getElementById('results-container');
        
        async function setupUserInterface() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) {
                if (window.location.pathname !== '/index.html' && window.location.pathname !== '/register.html') {
                    window.location.href = 'index.html';
                }
                return null;
            }
            const user = session.user;
            const mainApp = document.getElementById('main-app');
            if (mainApp) mainApp.style.display = 'block';
            if (userDisplay) userDisplay.textContent = `${user.email} でログイン中`;
            const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', user.id).single();
            const isAdmin = profile && profile.role === 'admin';
            
            document.querySelectorAll('.admin-only').forEach(link => {
                if (isAdmin) {
                    link.style.display = 'inline-block';
                }
            });
            return { user, isAdmin };
        }
        
        async function loadInitialData() {
            try {
                const { data: userData, error: userError } = await supabaseClient.from('user_data').select('subjects, target_majors').eq('id', currentUser.id).single();
                if (userError && userError.code !== 'PGRST116') throw userError;
                savedSubjects = (userData?.subjects || []).map(s => ({ name: s.name, credits: parseFloat(s.credits), grade: parseFloat(s.grade) })).filter(s => s.name && !isNaN(s.credits) && !isNaN(s.grade));
                targetMajors = userData?.target_majors || [];
                const { data: rulesData, error: rulesError } = await supabaseClient.from('major_rules').select('name, rule_data');
                if (rulesError) throw rulesError;
                allPublicRules = rulesData.map(r => ({ ...r.rule_data, name: r.name }));
                const { data: settingsData, error: settingsError } = await supabaseClient.from('app_settings').select('settings').eq('id', 1).single();
                if (settingsError) throw settingsError;
                rankingSettings = settingsData.settings;
            } catch (e) {
                resultsContainer.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--danger-color);">${e.message || 'データの読み込みに失敗しました。'}</td></tr>`;
                calculateBtn.disabled = true;
            }
        }
        document.addEventListener('DOMContentLoaded', async () => {
            const sessionInfo = await setupUserInterface();
            if (sessionInfo) {
                currentUser = sessionInfo.user;
                await loadInitialData();
            }
        });
        logoutBtn.addEventListener('click', async () => { await supabaseClient.auth.signOut(); window.location.href = 'index.html'; });
        calculateBtn.addEventListener('click', async () => {
            if (savedSubjects.length === 0) { alert('計算対象の科目がありません。「成績入力」ページでデータを保存してください。'); return; }
            if (targetMajors.length === 0) { alert('計算対象の学類がありません。「志望学類登録」ページで設定してください。'); return; }
            
            calculateBtn.disabled = true;
            calculateBtn.textContent = '計算・スコア更新中...';
            resultsContainer.innerHTML = '';
            
            try {
                const scoresToUpsert = [];
                allPublicRules.forEach(rule => {
                    const result = calculateCustomMajor(savedSubjects, rule);
                    scoresToUpsert.push({ id: currentUser.id, major: rule.name, score: result.score });
                });
                if (scoresToUpsert.length > 0) {
                    const { error: scoreSaveError } = await supabaseClient.from('user_scores').upsert(scoresToUpsert);
                    if (scoreSaveError) throw scoreSaveError;
                }
                const rulesToCalculate = allPublicRules.filter(rule => targetMajors.includes(rule.name));
                if (rulesToCalculate.length === 0) {
                    resultsContainer.innerHTML = `<tr><td colspan="5" style="text-align:center;">選択された志望学類に対応するルールが見つかりません。「ルール設定」ページでルールが作成されているか確認してください。</td></tr>`;
                } else {
                    rulesToCalculate.forEach(rule => {
                        const result = calculateCustomMajor(savedSubjects, rule);
                        renderResultRow(rule.name, result, rule);
                    });
                }
            } catch(error) {
                resultsContainer.innerHTML = `<tr><td colspan="5" style="text-align:center; color: var(--danger-color);">計算またはスコア更新中にエラーが発生しました: ${error.message}</td></tr>`;
            } finally {
                calculateBtn.disabled = false;
                calculateBtn.textContent = '計算を実行';
            }
        });
async function renderResultRow(majorName, result, rule) {
    let judgmentText = '';
    let rankInfoText = '';
    const percentage = result.maxScore > 0 ? (result.score / result.maxScore) * 100 : 0;
    const now = new Date();
    const startTime = rankingSettings.ranking_start_time ? new Date(rankingSettings.ranking_start_time) : null;
    const endTime = rankingSettings.ranking_end_time ? new Date(rankingSettings.ranking_end_time) : null;
    const isTimeValid = (!startTime || now >= startTime) && (!endTime || now <= endTime);
    
    let judgment = 'N/A';
    if (rankingSettings.ranking_enabled && isTimeValid) {
        if (rule.passThreshold && rule.medianThreshold) {
            const p_plus_thresh = rule.medianThreshold; const p_thresh = rule.passThreshold;
            const b_thresh = (p_plus_thresh + p_thresh) / 2; const d_thresh = p_thresh - (b_thresh - p_thresh);
            if (percentage >= p_plus_thresh) { judgment = 'A'; } 
            else if (percentage >= b_thresh) { judgment = 'B'; } 
            else if (percentage >= p_thresh) { judgment = 'C'; } 
            else if (percentage >= d_thresh) { judgment = 'D'; } 
            else { judgment = 'E'; }
        }
        judgmentText = `<span class="grade-badge grade-${judgment}">${judgment}</span>`;
        
        try {
            const { data, error } = await supabaseClient.rpc('get_rank_and_deviation', { major_name: majorName });
            if (error) throw new Error(error.message);
            if (!data || data.length === 0) { rankInfoText = 'N/A'; }
            else {
                const rankData = data[0];
                rankInfoText = `${rankData.rank} / ${rankData.total}人 (${rankData.deviation_score.toFixed(2)})`;
            }
        } catch (error) {
            rankInfoText = 'N/A';
        }
    } else {
        judgmentText = 'N/A';
        rankInfoText = '非公開';
    }
    
    const row = document.createElement('tr');
    row.innerHTML = `
        <td data-label="志望学類">${majorName || '名称未設定'}</td>
        <td data-label="移行点">${result.score.toFixed(2)}</td>
        <td data-label="得点率">${percentage.toFixed(2)} %</td>
        <td data-label="判定" style="text-align: center;">${judgmentText}</td>
        <td data-label="順位">${rankInfoText}</td>
    `;
    resultsContainer.appendChild(row);
}
    </script>
</body>
</html>
