<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ルール設定 - 成績計算サイト</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="supabase-client.js"></script>
</head>
<body>
    <div id="main-app" class="container" style="display:none;">
        <nav>
            <a href="input.html">成績入力</a>
            <a href="view.html">成績参照</a>
            <a href="judge.html">判定実行</a>
            <a href="majors.html">志望学類登録</a>
            <strong>ルール設定</strong>
            <a href="account.html">アカウント管理</a>
        </nav>
        <div class="user-status">
            <span id="user-display"></span>
            <button id="logout-btn" class="btn-danger" style="padding: 5px 10px; font-size: 14px;">ログアウト</button>
        </div>
        <div class="panel">
            <h2>学類計算ルール（全ユーザー共通）</h2>
            <p style="text-align:center;">ここで作成したルールは、全ユーザーが利用できます。編集・削除は作成者のみ可能です。</p>
            <div id="custom-majors-container"></div>
            <button id="add-major-btn" class="btn-action" style="margin-top: 20px;">新しい学類ルールを追加</button>
        </div>
    </div>
    <datalist id="master-subjects-list"></datalist>
    <script>
        let currentUser = null;
        let masterSubjects = [];
        let majorRules = [];
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const customMajorsContainer = document.getElementById('custom-majors-container');
        const addMajorBtn = document.getElementById('add-major-btn');
        const masterSubjectsDatalist = document.getElementById('master-subjects-list');
        async function setupUserInterface() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) {
                if (window.location.pathname !== '/index.html' && window.location.pathname !== '/register.html') {
                    window.location.href = 'index.html';
                }
                return null;
            }
            const user = session.user;
            const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', user.id).single();
            const isAdmin = profile && profile.role === 'admin';
            if (!isAdmin) {
                alert('アクセス権限がありません。');
                window.location.href = 'input.html';
                return null;
            }
            const mainApp = document.getElementById('main-app');
            if (mainApp) mainApp.style.display = 'block';
            if (userDisplay) userDisplay.textContent = `${user.email} でログイン中 [管理者]`;
            document.querySelectorAll('.admin-only').forEach(link => {
                if (isAdmin) { link.style.display = 'inline-block'; }
            });
            return { user, isAdmin };
        }
        async function initializeApp() {
            try {
                const response = await fetch('kdb_2025.csv');
                const csvText = await response.text();
                Papa.parse(csvText, { header: true, skipEmptyLines: true, complete: (results) => {
                    const uniqueSubjects = new Map();
                    results.data.forEach(row => {
                        const name = row['授業科目名'] ? row['授業科目名'].trim() : '';
                        const credits = parseFloat(row['単位数']);
                        if(name && !isNaN(credits)) {
                            const key = `${name}|${credits}`;
                            if (!uniqueSubjects.has(key)) { uniqueSubjects.set(key, { name, credits }); }
                        }
                    });
                    masterSubjects = Array.from(uniqueSubjects.values()).sort((a, b) => a.name.localeCompare(b.name, 'ja'));
                    masterSubjectsDatalist.innerHTML = '';
                    masterSubjects.forEach(subject => {
                        const option = document.createElement('option');
                        option.value = subject.name;
                        masterSubjectsDatalist.appendChild(option);
                    });
                }});
            } catch (error) { alert('科目マスターリストの読み込みに失敗しました。'); }
            await loadMajorRules();
        }
        async function loadMajorRules() {
            try {
                const { data, error } = await supabaseClient.from('major_rules').select('id, user_id, name, rule_data');
                if (error) throw error;
                majorRules = data.map(r => ({ id: r.id, userId: r.user_id, name: r.name, ...r.rule_data }));
                renderAllRules();
            } catch (e) { console.error('共通ルールの読み込み失敗:', e); }
        }
        function renderAllRules() {
            customMajorsContainer.innerHTML = '';
            majorRules.forEach((rule, index) => {
                const isOwner = rule.userId === currentUser.id;
                const ruleEl = createRuleElement(rule, index, isOwner);
                customMajorsContainer.appendChild(ruleEl);
            });
        }
        function createRuleElement(rule, majorIndex, isOwner) {
            const majorDiv = document.createElement('div');
            majorDiv.className = 'rule-editor';
            majorDiv.dataset.majorId = rule.id || `new-${majorIndex}`;
            let groupsHTML = '';
            (rule.groups || []).forEach((group) => {
                groupsHTML += createGroupHTML(group, isOwner);
            });
            majorDiv.innerHTML = `
                <div class="rule-editor-header">
                    <input type="text" class="major-name" value="${rule.name || ''}" placeholder="学類名" ${!isOwner && rule.id ? 'disabled' : ''} style="font-size: 1.2em; font-weight: bold;">
                    ${isOwner || !rule.id ? `<button class="btn-danger remove-major-btn" data-id="${rule.id || ''}">この学類を削除</button>` : ''}
                </div>
                <div class="rule-settings-grid">
                    <input type="number" class="total-cap" value="${rule.totalCap || ''}" placeholder="総単位数上限" ${!isOwner && rule.id ? 'disabled' : ''}>
                    <input type="number" class="other-weight" value="${rule.otherWeight || ''}" step="0.1" placeholder="その他重み" ${!isOwner && rule.id ? 'disabled' : ''}>
                    <input type="number" class="pass-threshold" value="${rule.passThreshold || ''}" step="0.1" placeholder="合格最低点(%)" ${!isOwner && rule.id ? 'disabled' : ''}>
                    <input type="number" class="median-threshold" value="${rule.medianThreshold || ''}" step="0.1" placeholder="中央値(%)" ${!isOwner && rule.id ? 'disabled' : ''}>
                </div>
                <div class="groups-container">${groupsHTML}</div>
                ${isOwner || !rule.id ? '<button class="btn-add add-group-btn">科目グループを追加</button>' : ''}
                ${isOwner || !rule.id ? `<button class="btn-main save-one-rule-btn" style="width:100%; margin-top:10px;">このルールを保存</button>` : ''}
            `;
            return majorDiv;
        }
        function createGroupHTML(group, isOwner) {
            let subjectsHTML = '';
            (group.subjects || []).forEach(subjectName => {
                subjectsHTML += `<div class="subject-tag">${subjectName}<span class="remove-subject-tag">&times;</span></div>`;
            });
            const disabledAttr = !isOwner ? 'disabled' : '';
            return `
                <div class="group-box">
                    <h4>科目グループ</h4>
                    <div class="rule-settings-grid">
                        <input type="text" class="group-name" value="${group.name || ''}" placeholder="グループ名" ${disabledAttr}>
                        <input type="number" class="group-weight" value="${group.weight || ''}" step="0.1" placeholder="重み" ${disabledAttr}>
                        <input type="number" class="group-cap" value="${group.cap || ''}" placeholder="単位数上限" ${disabledAttr}>
                    </div>
                    <h5>科目リスト</h5>
                    <div class="subjects-container">${subjectsHTML}</div>
                    ${isOwner ? `
                    <div class="subject-add-area">
                        <input type="text" class="new-subject-name" placeholder="科目名を入力 or 選択..." list="master-subjects-list">
                        <button type="button" class="btn-add add-subject-to-group-btn">追加</button>
                    </div>` : ''}
                    ${isOwner ? '<button class="btn-danger remove-group-btn" style="float: right;">このグループを削除</button>' : ''}
                </div>
            `;
        }
        document.addEventListener('DOMContentLoaded', async () => {
            const sessionInfo = await setupUserInterface();
            if(sessionInfo){
                currentUser = sessionInfo.user;
                await initializeApp();
            }
        });
        logoutBtn.addEventListener('click', async () => { await supabaseClient.auth.signOut(); window.location.href = 'index.html'; });
        addMajorBtn.addEventListener('click', () => {
            const newRule = { name: '', userId: currentUser.id, groups: [], totalCap: 24, otherWeight: 1.0, passThreshold: 0, medianThreshold: 0 };
            majorRules.push(newRule);
            renderAllRules();
        });
        customMajorsContainer.addEventListener('click', async (e) => {
            const target = e.target;
            const ruleEditor = target.closest('.rule-editor');
            if (!ruleEditor) return;
            if (target.classList.contains('remove-major-btn')) {
                const ruleId = ruleEditor.dataset.majorId;
                if (ruleId.startsWith('new-')) { ruleEditor.remove(); return; }
                const ruleName = ruleEditor.querySelector('.major-name').value;
                if (confirm(`「${ruleName}」を完全に削除しますか？この操作は元に戻せません。`)) {
                    const { error } = await supabaseClient.from('major_rules').delete().eq('id', ruleId);
                    if (error) alert('削除に失敗: ' + error.message);
                    else { alert('削除しました。'); await loadMajorRules(); }
                }
            } else if (target.classList.contains('add-group-btn')) {
                const groupsContainer = ruleEditor.querySelector('.groups-container');
                groupsContainer.insertAdjacentHTML('beforeend', createGroupHTML({}, true));
            } else if (target.classList.contains('remove-group-btn')) {
                target.closest('.group-box').remove();
            } else if (target.classList.contains('remove-subject-tag')) {
                target.parentElement.remove();
            } else if (target.classList.contains('add-subject-to-group-btn')) {
                const input = target.previousElementSibling;
                const subjectName = input.value.trim();
                if (subjectName) {
                    const subjectsContainer = input.closest('.group-box').querySelector('.subjects-container');
                    const existingSubjects = Array.from(subjectsContainer.querySelectorAll('.subject-tag')).map(t => t.textContent.slice(0, -1));
                    if (!existingSubjects.includes(subjectName)) {
                        subjectsContainer.insertAdjacentHTML('beforeend', `<div class="subject-tag">${subjectName}<span class="remove-subject-tag">&times;</span></div>`);
                    }
                    input.value = '';
                }
            } else if (target.classList.contains('save-one-rule-btn')) {
                const ruleId = ruleEditor.dataset.majorId.startsWith('new-') ? null : ruleEditor.dataset.majorId;
                const ruleData = {
                    name: ruleEditor.querySelector('.major-name').value.trim(),
                    rule_data: {
                        totalCap: parseFloat(ruleEditor.querySelector('.total-cap').value) || 0,
                        otherWeight: parseFloat(ruleEditor.querySelector('.other-weight').value) || 0,
                        passThreshold: parseFloat(ruleEditor.querySelector('.pass-threshold').value) || 0,
                        medianThreshold: parseFloat(ruleEditor.querySelector('.median-threshold').value) || 0,
                        groups: Array.from(ruleEditor.querySelectorAll('.group-box')).map(groupEl => ({
                            name: groupEl.querySelector('.group-name').value.trim(),
                            weight: parseFloat(groupEl.querySelector('.group-weight').value) || 0,
                            cap: parseFloat(groupEl.querySelector('.group-cap').value) || 0,
                            subjects: Array.from(groupEl.querySelectorAll('.subject-tag')).map(tag => tag.textContent.slice(0, -1))
                        }))
                    }
                };
                if (!ruleData.name) { alert('学類名は必須です。'); return; }
                let query;
                if (ruleId) {
                    query = supabaseClient.from('major_rules').update(ruleData).eq('id', ruleId);
                } else {
                    query = supabaseClient.from('major_rules').insert({ ...ruleData, user_id: currentUser.id });
                }
                const { error } = await query;
                if (error) { alert('保存に失敗: ' + error.message); }
                else { alert(`「${ruleData.name}」を保存しました。`); await loadMajorRules(); }
            }
        });
    </script>
</body>
</html>
