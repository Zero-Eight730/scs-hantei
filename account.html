<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>アカウント管理 - 成績計算サイト</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
</head>
<body>
    <div id="main-app" class="container" style="display:none;">
        <nav>
            <a href="input.html">成績入力</a>
            <a href="view.html">成績参照</a>
            <a href="judge.html">判定実行</a>
            <a href="majors.html">志望学類登録</a>
            <a href="rules.html" class="admin-only">ルール設定</a>
            <strong>アカウント管理</strong>
        </nav>
        <div class="user-status">
            <span id="user-display"></span>
            <button id="logout-btn" class="btn-danger" style="padding: 5px 10px; font-size: 14px;">ログアウト</button>
        </div>
        <div class="panel">
            <h2>アカウント管理</h2>
            <div class="account-section">
                <h3>メールアドレスの変更</h3>
                <p>現在のメールアドレス: <strong id="current-email"></strong></p>
                <input type="email" id="new-email" placeholder="新しいメールアドレス">
                <button id="update-email-btn" class="btn-action">変更を保存</button>
            </div>
            <hr>
            <div class="account-section">
                <h3>パスワードの変更</h3>
                <input type="password" id="new-password" placeholder="新しいパスワード（6文字以上）">
                <button id="update-password-btn" class="btn-action">変更を保存</button>
            </div>
            <hr>
            <div class="account-section">
                <h3>アカウントの削除</h3>
                <p style="color: var(--danger-color);">この操作は元に戻せません。すべての成績データが完全に削除されます。</p>
                <button id="delete-account-btn" class="btn-danger">アカウントを完全に削除する</button>
            </div>
        </div>
    </div>
    <script>
        let currentUser = null;
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const currentEmailEl = document.getElementById('current-email');
        const newEmailInput = document.getElementById('new-email');
        const updateEmailBtn = document.getElementById('update-email-btn');
        const newPasswordInput = document.getElementById('new-password');
        const updatePasswordBtn = document.getElementById('update-password-btn');
        const deleteAccountBtn = document.getElementById('delete-account-btn');
        
        async function setupUserInterface() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) {
                if (window.location.pathname !== '/index.html' && window.location.pathname !== '/register.html') {
                    window.location.href = 'index.html';
                }
                return null;
            }
            const user = session.user;
            const mainApp = document.getElementById('main-app');
            if (mainApp) mainApp.style.display = 'block';
            if (userDisplay) userDisplay.textContent = `${user.email} でログイン中`;
            if (currentEmailEl) currentEmailEl.textContent = user.email;
            const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', user.id).single();
            const isAdmin = profile && profile.role === 'admin';
            document.querySelectorAll('.admin-only').forEach(link => {
                if (isAdmin) { link.style.display = 'inline-block'; }
            });
            return { user, isAdmin };
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            const sessionInfo = await setupUserInterface();
            if(sessionInfo){
                currentUser = sessionInfo.user;
            }
        });

        logoutBtn.addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        });
        updateEmailBtn.addEventListener('click', async () => {
            const newEmail = newEmailInput.value.trim();
            if (!newEmail) { alert('新しいメールアドレスを入力してください。'); return; }
            const { data, error } = await supabaseClient.auth.updateUser(
                { email: newEmail },
                { emailRedirectTo: `${SITE_BASE_URL}/input.html` }
            );
            if (error) { alert('エラー: ' + error.message); } 
            else { alert('確認メールを新しいアドレスと古いアドレスの両方に送信しました。新しいメールのリンクをクリックして変更を完了してください。'); newEmailInput.value = ''; }
        });
        updatePasswordBtn.addEventListener('click', async () => {
            const newPassword = newPasswordInput.value;
            if (!newPassword || newPassword.length < 6) { alert('パスワードは6文字以上で入力してください。'); return; }
            const { data, error } = await supabaseClient.auth.updateUser({ password: newPassword });
            if (error) { alert('エラー: ' + error.message); } 
            else { alert('パスワードが正常に変更されました。'); newPasswordInput.value = ''; }
        });
        deleteAccountBtn.addEventListener('click', async () => {
            const confirmation = prompt('アカウントを本当に削除しますか？この操作は元に戻せません。\n\n確認のため、あなたの現在のメールアドレスを入力してください。');
            if (confirmation !== currentUser.email) { alert('メールアドレスが一致しません。操作はキャンセルされました。'); return; }
            const { data, error } = await supabaseClient.rpc('delete_user');
            if (error) { alert('アカウントの削除に失敗しました: ' + error.message); } 
            else {
                alert('アカウントが正常に削除されました。');
                await supabaseClient.auth.signOut();
                window.location.href = 'index.html';
            }
        });
    </script>
</body>
</html>
