<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成績参照 - 成績計算サイト</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-client.js"></script>
</head>
<body>
    <div id="main-app" class="container" style="display:none;">
        <nav>
            <a href="input.html">成績入力</a>
            <strong>成績参照</strong>
            <a href="judge.html">判定実行</a>
            <a href="majors.html">志望学類登録</a>
            <a href="rules.html" class="admin-only">ルール設定</a>
            <a href="account.html">アカウント管理</a>
        </nav>
        <div class="user-status">
            <span id="user-display"></span>
            <button id="logout-btn" class="btn-danger" style="padding: 5px 10px; font-size: 14px;">ログアウト</button>
        </div>
        <div class="panel">
            <h2>保存済み科目リスト</h2>
            <div class="table-wrapper">
                <table id="view-table">
                    <thead><tr><th>科目名</th><th>単位数</th><th>成績</th></tr></thead>
                    <tbody><tr><td colspan="3" style="text-align:center;">データを読み込み中...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>
    <script>
        let currentUser = null;

        async function setupUserInterface() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) {
                if (window.location.pathname !== '/index.html' && window.location.pathname !== '/register.html') {
                    window.location.href = 'index.html';
                }
                return null;
            }
            const user = session.user;
            const mainApp = document.getElementById('main-app');
            if (mainApp) mainApp.style.display = 'block';
            const userDisplay = document.getElementById('user-display');
            if (userDisplay) userDisplay.textContent = `${user.email} でログイン中`;
            const { data: profile } = await supabaseClient.from('profiles').select('role').eq('id', user.id).single();
            const isAdmin = profile && profile.role === 'admin';
            document.querySelectorAll('.admin-only').forEach(link => {
                if (isAdmin) { link.style.display = 'inline-block'; }
            });
            return { user, isAdmin };
        }
        
        async function loadAndDisplayGrades() {
            const tableBody = document.querySelector('#view-table tbody');
            try {
                const { data, error } = await supabaseClient.from('user_data').select('subjects').eq('id', currentUser.id).single();
                if (error && error.code !== 'PGRST116') throw new Error('データが見つかりません。入力ページで成績を保存してください。');
                const subjects = data ? data.subjects : [];
                tableBody.innerHTML = '';
                if (subjects.length > 0 && subjects.some(s => s.name)) {
                    subjects.forEach(s => {
                        const row = tableBody.insertRow();
                        row.innerHTML = `<td>${s.name || ''}</td><td>${s.credits || ''}</td><td>${s.grade || ''}</td>`;
                    });
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" style="text-align:center;">保存されている科目がありません。</td></tr>';
                }
            } catch (e) {
                tableBody.innerHTML = `<tr><td colspan="3" style="text-align:center;">${e.message}</td></tr>`;
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const sessionInfo = await setupUserInterface();
            if(sessionInfo) {
                currentUser = sessionInfo.user;
                await loadAndDisplayGrades();
            }
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        });
    </script>
</body>
</html>
