<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成績入力 - 成績計算サイト</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="supabase-client.js"></script>
    <script src="common.js"></script> </head>
<body>
    <div id="main-app" class="container" style="display:none;">
        <nav>
            <strong>成績入力</strong>
            <a href="view.html">成績参照</a>
            <a href="judge.html">判定実行</a>
            <a href="majors.html">志望学類登録</a>
            <a href="rules.html">ルール設定</a>
            <a href="account.html">アカウント管理</a>
        </nav>
        <div class="user-status">
            <span id="user-display"></span>
            <button id="logout-btn" class="btn-danger" style="padding: 5px 10px; font-size: 14px;">ログアウト</button>
        </div>
        <div class="panel">
            <h2>履修科目リストの編集</h2>
            <div class="search-section">
                <div id="loading-status"></div>
                <input type="text" id="search-input" placeholder="科目ライブラリから検索...">
                <div id="search-results"></div>
            </div>
            <div class="table-wrapper">
                <table id="subjects-table">
                    <thead>
                        <tr>
                            <th class="col-name">科目名</th>
                            <th class="col-credits">単位数</th>
                            <th class="col-grade">成績</th>
                            <th class="col-actions">操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button id="add-row-btn" class="btn-add">手動で科目を追加</button>
            <button id="save-btn" class="btn-main" style="width: 100%; margin-top: 20px;">現在のリストをサーバーに保存</button>
        </div>
    </div>
    <script>
        let masterSubjects = [];
        let currentUser = null;
        const userDisplay = document.getElementById('user-display');
        const logoutBtn = document.getElementById('logout-btn');
        const searchInput = document.getElementById('search-input');
        const searchResultsContainer = document.getElementById('search-results');
        const subjectsTableBody = document.querySelector('#subjects-table tbody');
        const addRowBtn = document.getElementById('add-row-btn');
        const saveBtn = document.getElementById('save-btn');
        const loadingStatus = document.getElementById('loading-status');
        
        async function checkSessionAndInitialize() { /* ... 変更なし ... */ }
        async function initializeApp() { /* ... 変更なし ... */ }
        function createSubjectRow(subject = {}) { /* ... 変更なし ... */ }
        function populateTable(subjects) { /* ... 変更なし ... */ }
        async function loadSubjects() { /* ... 変更なし ... */ }
        
        document.addEventListener('DOMContentLoaded', checkSessionAndInitialize);
        addRowBtn.addEventListener('click', () => createSubjectRow());
        subjectsTableBody.addEventListener('click', (e) => { /* ... 変更なし ... */ });
        logoutBtn.addEventListener('click', async () => { /* ... 変更なし ... */ });
        searchInput.addEventListener('input', () => { /* ... 変更なし ... */ });
        searchResultsContainer.addEventListener('click', (event) => { /* ... 変更なし ... */ });

        // === ▼▼▼ 保存ボタンのロジックを刷新 ▼▼▼ ===
        saveBtn.addEventListener('click', async () => {
            saveBtn.disabled = true;
            saveBtn.textContent = '保存中...';

            const subjectsRaw = Array.from(subjectsTableBody.querySelectorAll('tr')).map(row => ({
                name: row.querySelector('.subject-name').value.trim(),
                credits: row.querySelector('.subject-credits').value,
                grade: row.querySelector('.subject-grade').value
            })).filter(s => s.name);
            
            const subjectsForCalc = subjectsRaw.map(s => ({
                name: s.name,
                credits: parseFloat(s.credits),
                grade: parseFloat(s.grade)
            })).filter(s => !isNaN(s.credits) && !isNaN(s.grade));

            try {
                const { data: existingData } = await supabaseClient.from('user_data').select('custom_rules, target_majors').eq('id', currentUser.id).single();
                
                const { error: subjectSaveError } = await supabaseClient.from('user_data').upsert({ 
                    id: currentUser.id, 
                    subjects: subjectsRaw, 
                    custom_rules: existingData ? existingData.custom_rules : [],
                    target_majors: existingData ? existingData.target_majors : [],
                    updated_at: new Date() 
                });
                if (subjectSaveError) throw subjectSaveError;

                const { data: rulesData, error: rulesError } = await supabaseClient.from('major_rules').select('name, rule_data');
                if (rulesError) throw rulesError;

                const allRules = rulesData.map(r => ({ ...r.rule_data, name: r.name }));
                const scoresToUpsert = [];

                allRules.forEach(rule => {
                    const result = calculateCustomMajor(subjectsForCalc, rule);
                    scoresToUpsert.push({
                        id: currentUser.id,
                        user_id: currentUser.id,
                        major: rule.name,
                        score: result.score
                    });
                });
                
                if (scoresToUpsert.length > 0) {
                    const { error: scoreSaveError } = await supabaseClient.from('user_scores').upsert(scoresToUpsert, { onConflict: 'id, major' });
                    if (scoreSaveError) throw scoreSaveError;
                }

                alert('成績リストと計算済みスコアを保存しました。');
            } catch(error) {
                alert('保存に失敗しました: ' + error.message);
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = '現在のリストをサーバーに保存';
            }
        });
    </script>
</body>
</html>
